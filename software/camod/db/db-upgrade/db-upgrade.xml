<?xml version="1.0" encoding="UTF-8"?>
 
<databaseChangeLog
	xmlns="http://www.liquibase.org/xml/ns/dbchangelog/1.7"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog/1.7
	http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.7.xsd">
	<preConditions>            
		<or>
			<dbms type="oracle" />                     
			<!-- dbms type="mysql" /-->                     
			<!--dbms type="postgresql" /-->                     
		</or>
	</preConditions>                                       
	                                                        
	<changeSet id="2.6.1_INDUCED_MUTATION_TRIGGER" author="pandyas">                            
		<comment>INDUCED_MUTATION_TRIGGER can not be null for MTB data</comment>
    <sql>
		update ENVIRONMENTAL_FACTOR ef
		set ef.IS_INDUCED_MUTATION_TRIGGER = '0'
		where ef.IS_INDUCED_MUTATION_TRIGGER is null
    </sql> 
	</changeSet> 
	
	<changeSet id="2.6.2_move_TYPE_ALTERN_ENTRY" author="pandyas">                            
		<comment>Move ef.TYPE_ALTERN_ENTRY data to ef.TYPE for MTB records</comment>
    <sql>
		update ENVIRONMENTAL_FACTOR ef
		set ef.TYPE = ef.TYPE_ALTERN_ENTRY
		where ef.TYPE is null
		and ef.ENVIRONMENTAL_FACTOR_ID IN (
		select ef.ENVIRONMENTAL_FACTOR_ID 
		From ENVIRONMENTAL_FACTOR ef, ABS_CANCER_MODEL ac, CARCINOGEN_EXPOSURE ce 
		where ef.ENVIRONMENTAL_FACTOR_ID = ce.ENVIRONMENTAL_FACTOR_ID
		and ce.ABS_CANCER_MODEL_ID = ac.ABS_CANCER_MODEL_ID
		and ac.EXTERNAL_SOURCE = 'Jax MTB')
    </sql>
     <sql>
		update ENVIRONMENTAL_FACTOR ef
		set ef.TYPE_ALTERN_ENTRY = null
		where ef.ENVIRONMENTAL_FACTOR_ID IN (
		select ef.ENVIRONMENTAL_FACTOR_ID 
		from ENVIRONMENTAL_FACTOR ef, ABS_CANCER_MODEL ac, CARCINOGEN_EXPOSURE ce 
		where ef.ENVIRONMENTAL_FACTOR_ID = ce.ENVIRONMENTAL_FACTOR_ID
		and ce.ABS_CANCER_MODEL_ID = ac.ABS_CANCER_MODEL_ID
		and ac.EXTERNAL_SOURCE = 'Jax MTB')
    </sql> 
	</changeSet> 
	
	<changeSet id="2.6.3_move_NAME_ALTERN_ENTRY" author="pandyas">                            
		<comment>Move ef.NAME_ALTERN_ENTRY data to ef.NAME for MTB records</comment>
    <sql>
		update ENVIRONMENTAL_FACTOR ef
		set ef.NAME = ef.NAME_ALTERN_ENTRY
		where ef.NAME is null
		and ef.ENVIRONMENTAL_FACTOR_ID IN (
		select ef.ENVIRONMENTAL_FACTOR_ID 
		from ENVIRONMENTAL_FACTOR ef, ABS_CANCER_MODEL ac, CARCINOGEN_EXPOSURE ce 
		where ef.ENVIRONMENTAL_FACTOR_ID = ce.ENVIRONMENTAL_FACTOR_ID
		and ce.ABS_CANCER_MODEL_ID = ac.ABS_CANCER_MODEL_ID
		and ac.EXTERNAL_SOURCE = 'Jax MTB')
    </sql>
     <sql>
		update ENVIRONMENTAL_FACTOR ef
		set ef.NAME_ALTERN_ENTRY = null
		where ef.ENVIRONMENTAL_FACTOR_ID IN (
		select ef.ENVIRONMENTAL_FACTOR_ID 
		from ENVIRONMENTAL_FACTOR ef, ABS_CANCER_MODEL ac, carcinogen_exposure ce 
		where ef.ENVIRONMENTAL_FACTOR_ID = ce.ENVIRONMENTAL_FACTOR_ID
		and ce.ABS_CANCER_MODEL_ID = ac.ABS_CANCER_MODEL_ID
		and ac.EXTERNAL_SOURCE = 'Jax MTB')
    </sql> 
	</changeSet> 
	
	<changeSet id="2.6.4_delete_duplicate_MICRO_ARRAY_DATA_entries" author="pandyas">                            
		<comment>Delete duplicate MICRO_ARRAY_DATA records from table</comment>
    <sql>
		delete from MICRO_ARRAY_DATA
		where EXPERIMENT_ID is not null
    </sql>
	</changeSet> 
	
	<changeSet id="2.6.5_delete_orphan_DISEASE_entries" author="pandyas">                            
		<comment>Delete DISEASE entries without parent record in HISTOPATHOLOGY</comment>
    <sql>
		delete from DISEASE d 
		where d.NAME is null
		and d.NAME_ALTERN_ENTRY is null
		and d.DISEASE_ID NOT IN
		(select disease_id from HISTOPATHOLOGY h)
    </sql>
	</changeSet> 

	<changeSet id="2.6.6_delete_orphan_HISTOPATHOLOGY_entries" author="pandyas">                            
		<comment>Delete HISTOPATHOLOGY entries without parent record in ABSTRACT_CANCER_MODEL</comment>
    <sql>	
	delete FROM histopathology h
 	WHERE h.disease_id IN (SELECT disease_id
                          FROM disease
                         WHERE NAME IS NULL AND name_altern_entry IS NULL)
   	AND h.abs_cancer_model_id IS NULL
   	AND h.parent_histopathology_id IS NULL
    </sql>
	</changeSet> 	
</databaseChangeLog>

